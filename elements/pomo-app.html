<dom-module id="pomo-app">
  <style>
    :host {
      display: block;
      background-color: #292929;
      font-family: Roboto "Courier New" monospace;
    }

    :host.pm {
      background-color: #ffa3b6;
    }

    :host.sb {
      background-color: #93e8ff;
    }

    :host.lb {
      background-color: #c0ff77;
    }

    time-view {
      padding: 20px;
    }
  </style>
  <template>
    <div class="fit horizontal layout">
      <div class="flex self-center">
        <div class="flex vertical layout center">
          <pomo-state id="pomoState" state="[[activeTime.type]]"></pomo-state>
          <time-view current-time="[[activeTime.remain]]"></time-view>
          <pomo-control on-play="play" on-pause="pause" on-stop="stop" on-next="next"></pomo-control>
        </div>
      </div>
    </div>
    <!-- Declarations -->
    <sec-countdown id="countdown" current-time="{{activeTime.remain}}"></sec-countdown>
    <pomo-alarm id="alarm"
                time="[[activeTime.remain]]"
                alarm="0"
                on-alarm="handleAlarm">
    </pomo-alarm>
    <audio id="audioPlayer" src="../audio/stop.mp3"></audio>

  </template>

  <script>
    "use strict";

    var pomodoroCounting = 0;

    Polymer({
      is: 'pomo-app',
      properties: {
        pomodoroDuration: {
          type: Number,
          value: 5 //25 * 60
        },

        shortBreakDuration: {
          type: Number,
          value: 5 * 60
        },

        longBreakDuration: {
          type: Number,
          value: 15 * 60
        },

        longBreakInterval: {
          type: Number,
          value: 4
        },

        /**
         * Tempo atual
         */
        activeTime: {
          type: Object,
          value: null,
          observer: '_activeTimeChanged'
        },

      },
      observers:[
        '_updateState(activeTime.type)'
      ],
      ready: function() {
        console.log('ready');
        this.init();
      },
      play: function() {
        console.log('play');
        this.$.countdown.start();
      },
      stop: function() {
        console.log('stop');
        this.$.countdown.stop();
        this.init();
      },
      pause: function() {
        console.log('pause');
        this.$.countdown.stop();
      },
      next: function(finished) {
        console.log(next);
        var next;
        switch (this.activeTime.type) {
          case 'p':
            if (finished) {
              pomodoroCounting++;
            }
            if (pomodoroCounting >= this.longBreakInterval) {
              pomodoroCounting = 0;
              next = this._createNewBreak('l');
            } else {
              next = this._createNewBreak('s');
            }
            break;
          case 's':
          case 'l':
            next = this._createNewPomodoro();
        }

        this.activeTime = next;
      },
      init: function() {
        this.activeTime = this._createNewPomodoro(1);
      },
      _createNewBreak: function(type) {
        var result = {};
        result.type = type;
        result.duration = (type == 's'
          ? this.shortBreakDuration
          : this.longBreakDuration);
        result.remain = result.duration;

        return result;
      },
      _createNewPomodoro: function() {
        var result = {};
        result.type = 'p';
        result.duration = this.pomodoroDuration;
        result.remain = result.duration;

        return result;
      },
      handleAlarm: function(e) {
        console.log('Alarm:', e);
        this.$.audioPlayer.play();
        this.next(true);
      },

      _activeTimeChanged: function(newValue, oldValue) {
        console.log('State changed: ', newValue);
      },

      _updateState: function(type) {
        /*this.toggleClass('pm', type == 'p');
        this.toggleClass('sb', type == 's');
        this.toggleClass('lb', type == 'l');*/
      }

    });
  </script>
</dom-module>
